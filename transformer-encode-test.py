from sentence_transformers import SentenceTransformer
import numpy
model = SentenceTransformer('msmarco-distilbert-base-tas-b')

def quickTick(success: bool) -> str:
  return '✅' if success else '❌'

def expect(condition, message):
  print(quickTick(condition), message)

def verify_encode_batch_behaviour():
  batch = model.encode(["hello world", "hello world"])
  single = model.encode("hello world")
  expect(numpy.array_equal(batch[0], batch[1]), 'Expect embeddings in batch are equal')
  expect(not numpy.array_equal(single[0], batch[1]), 'Expect embedding from different run of same word are not equal')


def verify_encode_max_sequence_length_behaviour():
  sentence_512 = "the region of Transoxiana had been conquered by the Muslim Arabs of the Syria-based Umayyad Caliphate under Qutayba ibn Muslim in the reign of al-Walid I (r. 705–715), following the Muslim conquest of Persia and of Khurasan in the mid-7th century.[1] The loyalties of the region's native Iranian and Turkic inhabitants and autonomous local rulers remained volatile, and in 719, they sent a petition to the Chinese and their vassals the Türgesh (a Turkic tribal confederation) for military aid against the Muslims.[2] In response, Türgesh attacks began in 720, and the native Sogdians launched uprisings against the Caliphate. These were suppressed with great brutality by the governor of Khurasan, Sa'id ibn Amr al-Harashi, but in 724 his successor, Muslim ibn Sa'id al-Kilabi, suffered a major disaster (the so-called Day of Thirst) while trying to capture Ferghana.[3][4] For the next few years, Umayyad forces were limited to the defensive. Efforts to placate and win the support of the local population by abolishing taxation of the native converts to Islam (mawali) were undertaken, but these were half-hearted and soon reversed, while heavy-handed Arab actions further alienated the local elites. In 728 a large-scale uprising, coupled with a Türgesh invasion, led to the abandonment of most of Transoxiana by the Caliphate's forces, except for the region around Samarkand.[5][6]In the hope of reversing the situation, in early 730 Caliph Hisham ibn Abd al-Malik (r. 723–743) appointed a new governor in Khurasan: the experienced general Junayd ibn Abd al-Rahman al-Murri, who had been recently engaged in the pacification of Sindh. The difficult security situation at the time is illustrated by the fact that Junayd needed an escort of 7,000 cavalry after crossing the Oxus River, and that he was attacked by the Türgesh khagan Suluk while riding to link up with the army of his predecessor, Ashras al-Sulami, who in the previous year had advanced up to Bukhara in a hard-fought campaign. After difficult fighting, Junayd and his escort were able to repel the attack and link up with al-Sulami's forces. Bukhara and most of Sogdiana was recovered soon after, as the Türgesh army withdrew north towards Samarkand. The Muslim army followed and scored a victory in a battle fought near the city. Junayd then retired with his troops to winter in Merv.[7][8] During the winter, rebellions broke out south of the Oxus in Tokharistan, which had previously been quiescent under Muslim rule. Junayd was forced to set out for Balkh and there dispersed 28,000 of his men to quell the revolt. This left him seriously short of men when, in early 731, the Türgesh laid siege to Samarkand and appeals for aid arrived from the city's governor, Sawra ibn al-Hurr al-Abani. Despite the opinion of the army's veteran Khurasani Arab leaders, who counselled that he should wait to reassemble his forces and not cross the Oxus with less than 50,000 men Junayd resolved to march immediately to Samarkand's rescue. This left him seriously short of men when, in early 731, the Türgesh laid siege to Samarkand and appeals for aid arrived from the city"
  sentence_513 = "the region of Transoxiana had been conquered by the Muslim Arabs of the Syria-based Umayyad Caliphate under Qutayba ibn Muslim in the reign of al-Walid I (r. 705–715), following the Muslim conquest of Persia and of Khurasan in the mid-7th century.[1] The loyalties of the region's native Iranian and Turkic inhabitants and autonomous local rulers remained volatile, and in 719, they sent a petition to the Chinese and their vassals the Türgesh (a Turkic tribal confederation) for military aid against the Muslims.[2] In response, Türgesh attacks began in 720, and the native Sogdians launched uprisings against the Caliphate. These were suppressed with great brutality by the governor of Khurasan, Sa'id ibn Amr al-Harashi, but in 724 his successor, Muslim ibn Sa'id al-Kilabi, suffered a major disaster (the so-called Day of Thirst) while trying to capture Ferghana.[3][4] For the next few years, Umayyad forces were limited to the defensive. Efforts to placate and win the support of the local population by abolishing taxation of the native converts to Islam (mawali) were undertaken, but these were half-hearted and soon reversed, while heavy-handed Arab actions further alienated the local elites. In 728 a large-scale uprising, coupled with a Türgesh invasion, led to the abandonment of most of Transoxiana by the Caliphate's forces, except for the region around Samarkand.[5][6]In the hope of reversing the situation, in early 730 Caliph Hisham ibn Abd al-Malik (r. 723–743) appointed a new governor in Khurasan: the experienced general Junayd ibn Abd al-Rahman al-Murri, who had been recently engaged in the pacification of Sindh. The difficult security situation at the time is illustrated by the fact that Junayd needed an escort of 7,000 cavalry after crossing the Oxus River, and that he was attacked by the Türgesh khagan Suluk while riding to link up with the army of his predecessor, Ashras al-Sulami, who in the previous year had advanced up to Bukhara in a hard-fought campaign. After difficult fighting, Junayd and his escort were able to repel the attack and link up with al-Sulami's forces. Bukhara and most of Sogdiana was recovered soon after, as the Türgesh army withdrew north towards Samarkand. The Muslim army followed and scored a victory in a battle fought near the city. Junayd then retired with his troops to winter in Merv.[7][8] During the winter, rebellions broke out south of the Oxus in Tokharistan, which had previously been quiescent under Muslim rule. Junayd was forced to set out for Balkh and there dispersed 28,000 of his men to quell the revolt. This left him seriously short of men when, in early 731, the Türgesh laid siege to Samarkand and appeals for aid arrived from the city's governor, Sawra ibn al-Hurr al-Abani. Despite the opinion of the army's veteran Khurasani Arab leaders, who counselled that he should wait to reassemble his forces and not cross the Oxus with less than 50,000 men Junayd resolved to march immediately to Samarkand's rescue. This left him seriously short of men when, in early 731, the Türgesh laid siege to Samarkand and appeals for aid arrived from the city's gorvernor."
  
  embedding_512 = model.encode(sentence_512)
  embedding_513 = model.encode(sentence_513)
  
  expect(model.max_seq_length == 512, 'Expected model.max_sequence_length is equal to 512')
  expect(numpy.array_equal(embedding_512, embedding_513), 'Expected embedding of 512 words equal to embedding of 513 word')

  batch = model.encode([sentence_512, "hello world", sentence_513])

  expect(numpy.array_equal(batch[0], batch[2]), 'Expected first item equal third item in batch')
  expect(not numpy.array_equal(batch[0], batch[1]), 'Expected first item not equal to second item in batch')
  

if __name__ == '__main__':
  verify_encode_batch_behaviour()
  verify_encode_max_sequence_length_behaviour()